!-------------------------------------------------------------------------
!NASA/GSFC, Global Modeling and Assimilation Office, Code 610.1, GEOS/DAS!
!-------------------------------------------------------------------------
!BOP
!
! !INTERFACE:

 REAL FUNCTION GetCO2(Year, DayOfYear)

! !DESCRIPTION:
!
!  Given the year and day-of-year, this function returns the RCP85 CO2 concentration in 
!  mole fraction (volume mixing ratio).  If Year is less than 1765, the value for 1765
!  is returned.  If Year is greater than 2150, the value for 2150 is returned.  In the
!  original dataset, the value for 2150 is used for all years through 2500.  We choose
!  to truncate the list at 2151 for this application.
!
!  DayOfYear is expected to have a value of 1.00 at 0:00 UTC Jan 1.
!
!  In-line documentation from the source dataset is reproduced below:
!RCP85__MIDYEAR__CONCENTRATIONS____________________________
!CONTENT:           CMIP5 RECOMMENDATIONS FOR ANNUAL AVERAGE, GLOBAL MEAN CONCENTRATIONS.
!RUN:               RCP8.5, FINAL RELEASE, 26 Nov. 2009
!RCP4.5 CONTACT:    MESSAGE group, Keywan Riahi (riahi@iiasa.ac.at)
!DATE:              26/11/2009 11:11:43
!MAGICC-VERSION:    6.3.09, 25 November 2009
!FILE PRODUCED BY:  RCP Concentration Calculation & Data Group, M. Meinshausen, S. Smith, K. Riahi, D. van Vuuren
!CMIP5 INFO:        http://cmip-pcmdi.llnl.gov/cmip5/
!RCP DATABASE:      http://www.iiasa.ac.at/web-apps/tnt/RcpDb
!DESCRIPTION:       For data sources, aknowledgements and further information, see http://www.pik-potsdam.de/~mmalte/rcps
!NOTE:              RCP8.5 starts 2005; 20th century data and earlier is provided for convenience.
!
! !REVISION HISTORY:
!  29 Oct 2010  Nielsen, adapted for GEOS-5.
! 
!EOP
! ---------------------------------------------------------------------------------

  IMPLICIT NONE
  INTEGER, INTENT(IN) :: Year
  INTEGER, INTENT(IN) :: DayOfYear

  REAL :: f,i,n
  INTEGER :: previous,current,next
  
  INTEGER, PARAMETER :: firstYear = 1764
  INTEGER, PARAMETER :: finalYear = 2151
  INTEGER, PARAMETER :: tableLength = finalYear-firstYear+1

  REAL, SAVE :: CO2ppmv(tableLength) = (/                                278.052, &
   278.052,  278.106,  278.220,  278.343,  278.471,  278.600,  278.733,  278.869, &
   279.009,  279.153,  279.302,  279.457,  279.618,  279.782,  279.943,  280.097, &
   280.243,  280.382,  280.518,  280.657,  280.803,  280.957,  281.118,  281.282, &
   281.443,  281.598,  281.747,  281.891,  282.031,  282.167,  282.299,  282.427, &
   282.551,  282.671,  282.787,  282.899,  283.007,  283.111,  283.211,  283.307, &
   283.400,  283.490,  283.578,  283.661,  283.735,  283.797,  283.847,  283.889, &
   283.926,  283.963,  284.001,  284.043,  284.086,  284.129,  284.167,  284.198, &
   284.223,  284.244,  284.263,  284.281,  284.300,  284.320,  284.340,  284.360, &
   284.380,  284.400,  284.385,  284.280,  284.125,  283.975,  283.825,  283.675, &
   283.525,  283.425,  283.400,  283.400,  283.425,  283.500,  283.600,  283.725, &
   283.900,  284.075,  284.225,  284.400,  284.575,  284.725,  284.875,  285.000, &
   285.125,  285.275,  285.425,  285.575,  285.725,  285.900,  286.075,  286.225, &
   286.375,  286.500,  286.625,  286.775,  286.900,  287.000,  287.100,  287.225, &
   287.375,  287.525,  287.700,  287.900,  288.125,  288.400,  288.700,  289.025, &
   289.400,  289.800,  290.225,  290.700,  291.200,  291.675,  292.125,  292.575, &
   292.975,  293.300,  293.575,  293.800,  294.000,  294.175,  294.325,  294.475, &
   294.600,  294.700,  294.800,  294.900,  295.025,  295.225,  295.500,  295.800, &
   296.125,  296.475,  296.825,  297.200,  297.625,  298.075,  298.500,  298.900, &
   299.300,  299.700,  300.075,  300.425,  300.775,  301.100,  301.400,  301.725, &
   302.075,  302.400,  302.700,  303.025,  303.400,  303.775,  304.125,  304.525, &
   304.975,  305.400,  305.825,  306.300,  306.775,  307.225,  307.700,  308.175, &
   308.600,  309.000,  309.400,  309.750,  310.000,  310.175,  310.300,  310.375, &
   310.375,  310.300,  310.200,  310.125,  310.100,  310.125,  310.200,  310.325, &
   310.500,  310.750,  311.100,  311.500,  311.925,  312.425,  313.000,  313.600, &
   314.225,  314.848,  315.500,  316.272,  317.075,  317.795,  318.397,  318.925, &
   319.647,  320.647,  321.605,  322.635,  323.902,  324.985,  325.855,  327.140, &
   328.677,  329.742,  330.585,  331.747,  333.272,  334.848,  336.525,  338.360, &
   339.728,  340.793,  342.198,  343.783,  345.283,  346.797,  348.645,  350.737, &
   352.487,  353.855,  355.017,  355.885,  356.777,  358.128,  359.837,  361.462, &
   363.155,  365.323,  367.348,  368.865,  370.467,  372.522,  374.760,  376.813, & !1997-2004
   378.813,  380.828,  382.778,  384.800,  387.012,  389.324,  391.638,  394.009, &
   396.464,  399.004,  401.628,  404.328,  407.096,  409.927,  412.822,  415.780, & !2013-2020
   418.796,  421.864,  424.995,  428.197,  431.475,  434.826,  438.245,  441.721, &
   445.251,  448.835,  452.474,  456.177,  459.964,  463.852,  467.850,  471.960, & !2029-2036
   476.182,  480.508,  484.927,  489.435,  494.032,  498.729,  503.530,  508.433, &
   513.456,  518.611,  523.900,  529.324,  534.875,  540.543,  546.322,  552.212, & !2045-2052
   558.212,  564.313,  570.517,  576.843,  583.305,  589.905,  596.647,  603.520, &
   610.517,  617.605,  624.764,  631.995,  639.291,  646.653,  654.098,  661.645, & !2061-2068
   669.305,  677.078,  684.954,  692.902,  700.894,  708.932,  717.015,  725.135, &
   733.307,  741.524,  749.805,  758.182,  766.645,  775.174,  783.751,  792.366, & !2077-2084
   801.019,  809.715,  818.422,  827.157,  835.956,  844.805,  853.725,  862.726, &
   871.777,  880.864,  889.982,  899.124,  908.289,  917.471,  926.665,  935.874, & !2093-2100
   945.132,  954.466,  963.839,  973.241,  982.680,  992.143,  1001.63,  1011.12, &
   1020.61,  1030.10,  1039.59,  1049.12,  1058.70,  1068.32,  1078.00,  1087.70, & !2109-2116
   1097.43,  1107.18,  1116.91,  1126.66,  1136.40,  1146.13,  1155.90,  1165.74, &
   1175.62,  1185.53,  1195.48,  1205.48,  1215.47,  1225.45,  1235.45,  1246.86, & !2125-2132
   1255.40,  1265.42,  1275.48,  1285.59,  1295.76,  1305.96,  1316.17,  1326.39, &
   1336.63,  1346.85,  1357.07,  1367.28,  1377.51,  1387.79,  1398.14,  1408.52, & !2141-2148
   1418.95,  1429.40,  1439.84 /)

! Establish location in table for current, previous and next year.
! ----------------------------------------------------------------
  current  = Year-firstYear+1
  current  = MAX(current,1)
  current  = MIN(current,tableLength)

  previous = current-1
  previous = MAX(previous,1)
  previous = MIN(previous,tableLength)
  IF(Year > finalYear) previous = tableLength

  next     = current+1
  next     = MAX(next,1)
  next     = MIN(next,tableLength)
  IF(Year < firstYear) next = 1

! Divide the year into halves.
! ----------------------------
  IF(dayOfYear <= 182) THEN
   i = CO2ppmv(previous)
   f = CO2ppmv(current)
   n = dayOfYear+183
  ELSE
   i = CO2ppmv(current)
   f = CO2ppmv(next)
   n = dayOfYear-183
  END IF

! Linear interpolation to the given day-of-year.
! ----------------------------------------------
  GetCO2 = i + (f-i)*n/365.00

! Convert to mole fraction (volume mixing ratio).
! -----------------------------------------------
  GetCO2 = GetCO2*1.00E-06

 END FUNCTION GetCO2
